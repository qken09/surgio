(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{202:function(t,a,s){t.exports=s.p+"assets/img/api-gateway-preview.9e03d17d.png"},213:function(t,a,s){"use strict";s.r(a);var e=s(0),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"快速搭建托管-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#快速搭建托管-api","aria-hidden":"true"}},[t._v("#")]),t._v(" 快速搭建托管 API")]),t._v(" "),e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),e("p",[t._v("本文亦发布于我的个人博客 "),e("a",{attrs:{href:"https://blog.dada.li/2019/surgio-api-gateway",target:"_blank",rel:"noopener noreferrer"}},[t._v("blog.dada.li"),e("OutboundLink")],1)])]),t._v(" "),e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),e("p",[t._v("相信很多人都用过网络上处理规则的 API 接口，也有人在使用过 Surgio 后觉得更新规则不太灵活。虽然我们已经能够通过自动化的方法每隔一段时间更新一次规则，但还是无法做到实时更新。这篇文章就是想教大家，利用现成的 SAAS(Software as a Service) 服务，来实现一个 Surgio 规则仓库的 API。")]),t._v(" "),e("h2",{attrs:{id:"简述实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#简述实现","aria-hidden":"true"}},[t._v("#")]),t._v(" 简述实现")]),t._v(" "),e("p",[t._v("目前 Surgio 支持两个部署平台，阿里云函数服务和 zeit 的 now.sh。他们各自有各自的优缺点，由各位定夺使用谁（无法同时使用）。")]),t._v(" "),e("h3",{attrs:{id:"阿里云函数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#阿里云函数","aria-hidden":"true"}},[t._v("#")]),t._v(" 阿里云函数")]),t._v(" "),e("p",[t._v("优点：")]),t._v(" "),e("ul",[e("li",[t._v("有免费额度")]),t._v(" "),e("li",[t._v("有香港机房")])]),t._v(" "),e("p",[t._v("缺点：")]),t._v(" "),e("ul",[e("li",[t._v("管理复杂（文档很多很杂）")])]),t._v(" "),e("h3",{attrs:{id:"now-sh"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#now-sh","aria-hidden":"true"}},[t._v("#")]),t._v(" now.sh "),e("Badge",{attrs:{text:"推荐",vertical:"middle"}})],1),t._v(" "),e("p",[t._v("优点：")]),t._v(" "),e("ul",[e("li",[t._v("管理简单")]),t._v(" "),e("li",[t._v("按量付费")]),t._v(" "),e("li",[t._v("有香港边缘服务器节点（源站位于美国）")])]),t._v(" "),e("p",[t._v("缺点：")]),t._v(" "),e("ul",[e("li",[t._v("有免费额度但是源码公开")])]),t._v(" "),e("h2",{attrs:{id:"部署-now-sh"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-now-sh","aria-hidden":"true"}},[t._v("#")]),t._v(" 部署 - now.sh "),e("Badge",{attrs:{text:"推荐",vertical:"middle"}})],1),t._v(" "),e("h3",{attrs:{id:"准备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#准备","aria-hidden":"true"}},[t._v("#")]),t._v(" 准备")]),t._v(" "),e("ol",[e("li",[t._v("注册一个 "),e("a",{attrs:{href:"https://now.sh",target:"_blank",rel:"noopener noreferrer"}},[t._v("now.sh"),e("OutboundLink")],1),t._v(" 账号")]),t._v(" "),e("li",[t._v("按量付费需要绑定信用卡（必须）")])]),t._v(" "),e("h3",{attrs:{id:"配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),e("p",[t._v("首先，安装工具链。")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" i -g now\n")])])]),e("p",[t._v("登录账号。")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ now login\n")])])]),e("p",[t._v("新建文件 "),e("code",[t._v("now.json")]),t._v("，注意修改代码中 "),e("code",[t._v("<...>")]),t._v(" 部分。")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<输入服务名 (例如 surgio-api)>"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"version"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"public"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"builds"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"src"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"gateway.js"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"use"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@now/node"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"config"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"includeFiles"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"provider/**"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"template/**"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*.js"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*.json"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"routes"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"src"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/(.*)"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"methods"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"HEAD"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"dest"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/gateway.js"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("在 "),e("code",[t._v("package.json")]),t._v(" 中增加如下字段：")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"engines"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"node"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.x"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h3",{attrs:{id:"编写云函数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#编写云函数","aria-hidden":"true"}},[t._v("#")]),t._v(" 编写云函数")]),t._v(" "),e("p",[t._v("新建文件 "),e("code",[t._v("gateway.js")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'use strict'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" gateway "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'surgio/build/gateway'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmodule"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gateway"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createHttpServer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"配置-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),e("h4",{attrs:{id:"接口鉴权"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#接口鉴权","aria-hidden":"true"}},[t._v("#")]),t._v(" 接口鉴权")]),t._v(" "),e("div",{staticClass:"warning custom-block"},[e("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),e("p",[t._v("接口鉴权依赖使用新版的部署方法，旧的 "),e("code",[t._v("nowHandler")]),t._v(" 不支持。")])]),t._v(" "),e("p",[t._v("在 "),e("code",[t._v("surgio.conf.js")]),t._v(" 中增加如下字段：")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  gateway"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    auth"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    accessToken"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'YOUR_PASSWORD'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("div",{staticClass:"tip custom-block"},[e("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),e("p",[t._v("对于已经部署了托管接口的用户，推荐不要第一时间打开鉴权功能，而是配置 "),e("code",[t._v("accessToken")]),t._v(" 一段时间后再将 "),e("code",[t._v("auth")]),t._v(" 改为 "),e("code",[t._v("true")]),t._v("。这样可以让已经下载过旧托管文件的客户端更新到新的包含有 "),e("code",[t._v("access_token")]),t._v(" 参数的托管文件。")])]),t._v(" "),e("h3",{attrs:{id:"部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署","aria-hidden":"true"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ now\n")])])]),e("p",[t._v("如果不出意外你会看到如图的信息，高亮的 URL 即为云函数服务的访问地址。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.typcdn.com/geekdada/8428848087_769637.png",alt:"carbon.png"}})]),t._v(" "),e("p",[t._v("为了让托管地址保持一致，你需要到 "),e("code",[t._v("surgio.conf.js")]),t._v(" 把 "),e("code",[t._v("urlBase")]),t._v(" 更新为：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("https://xxxxxx.xxx.now.sh/get-artifact/\n")])])]),e("p",[t._v("最后，再运行一次 "),e("code",[t._v("now")]),t._v(" 更新服务。")]),t._v(" "),e("h3",{attrs:{id:"使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用")]),t._v(" "),e("p",[t._v("在以下地址能看到所有 Artifact，方便你使用下载。")]),t._v(" "),e("h4",{attrs:{id:"未开启鉴权"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#未开启鉴权","aria-hidden":"true"}},[t._v("#")]),t._v(" 未开启鉴权")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("https://xxxxxx.xxx.now.sh/list-artifact\n")])])]),e("h4",{attrs:{id:"开启鉴权"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开启鉴权","aria-hidden":"true"}},[t._v("#")]),t._v(" 开启鉴权")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("https://xxxxxx.xxx.now.sh/list-artifact?access_token=YOUR_PASSWORD\n")])])]),e("p",[e("img",{attrs:{src:s(202),alt:""}})]),t._v(" "),e("h4",{attrs:{id:"特性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#特性","aria-hidden":"true"}},[t._v("#")]),t._v(" 特性")]),t._v(" "),e("ul",[e("li",[t._v("若名称中包含 "),e("code",[t._v("surge")]),t._v("（大小写不敏感），则会出现添加到 Surge 的按钮。")]),t._v(" "),e("li",[t._v("若项目下的 "),e("code",[t._v("package.json")]),t._v(" 有 "),e("code",[t._v("repository")]),t._v(" 字段，则支持直接跳转到 GitLab 或 GitHub 编辑对应文件。")])]),t._v(" "),e("h3",{attrs:{id:"最后"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#最后","aria-hidden":"true"}},[t._v("#")]),t._v(" 最后")]),t._v(" "),e("p",[t._v("有几点需要大家注意的：")]),t._v(" "),e("ol",[e("li",[t._v("每一次更新本地的代码，都需要执行一次 "),e("code",[t._v("now")]),t._v("，保证远端和本地代码一致")]),t._v(" "),e("li",[t._v("访问日志、监控、域名绑定等复杂功能恕不提供教程")]),t._v(" "),e("li",[t._v("如果访问地址泄漏，请立即删除云函数然后修改机场密码")])]),t._v(" "),e("h2",{attrs:{id:"部署-阿里云函数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-阿里云函数","aria-hidden":"true"}},[t._v("#")]),t._v(" 部署 - 阿里云函数")]),t._v(" "),e("p",[t._v("首先需要确保本地 Surgio 版本已经更新到 v0.12.4 或更新。")]),t._v(" "),e("h3",{attrs:{id:"准备-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#准备-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 准备")]),t._v(" "),e("ol",[e("li",[t._v("注册一个阿里云账号，最好是国内的因为我不清楚国际版有什么差异")]),t._v(" "),e("li",[t._v("开启 "),e("a",{attrs:{href:"https://fc.console.aliyun.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("云函数功能"),e("OutboundLink")],1)])]),t._v(" "),e("h3",{attrs:{id:"配置-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-3","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),e("p",[t._v("首先，安装"),e("a",{attrs:{href:"https://github.com/alibaba/funcraft",target:"_blank",rel:"noopener noreferrer"}},[t._v("云函数工具链"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" @alicloud/fun -g\n")])])]),e("p",[t._v("在使用工具链之前，需要做一些基本的配置。在控制台中输入：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ fun config\n")])])]),e("p",[t._v("然后按照提示，依次配置 "),e("code",[t._v("Account ID")]),t._v(", "),e("code",[t._v("Access Key Id")]),t._v(", "),e("code",[t._v("Secret Access Key")]),t._v(", "),e("code",[t._v("Default Region Name")]),t._v("。关于服务区的选择，我建议避免使用大陆服务区。")]),t._v(" "),e("p",[t._v("在仓库中新建文件 "),e("code",[t._v("template.yml")]),t._v("，注意修改代码中 "),e("code",[t._v("<...>")]),t._v(" 部分。")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ROSTemplateFormatVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2015-09-01'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Transform")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Aliyun::Serverless-2018-04-03'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Resources")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  <输入服务名 (例如 surgio"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("api)>")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Aliyun::Serverless::Service'")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Properties")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Description")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Surgio API service'")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("get-artifact")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Aliyun::Serverless::Function'")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Properties")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Handler")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gateway.handler\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Initializer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gateway.initializer\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("CodeUri")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./'")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Runtime")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nodejs10\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Events")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http-service")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" HTTP\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Properties")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("AuthType")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ANONYMOUS\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Methods")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'HEAD'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),e("p",[t._v("新建文件 "),e("code",[t._v(".funignore")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# Logs\nlogs/\n*.log\n\n# Dependency directories\n!/node_modules/\n")])])]),e("h3",{attrs:{id:"编写云函数-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#编写云函数-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 编写云函数")]),t._v(" "),e("p",[t._v("新建文件 "),e("code",[t._v("gateway.js")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'use strict'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" gateway "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'surgio/build/gateway'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nexports"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("initializer "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gateway"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("initializer\nexports"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handler "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" gateway"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handler"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"部署-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ fun deploy\n")])])]),e("p",[t._v("如果不出意外你会看到如图的信息，高亮的 URL 即为云函数服务的访问地址。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.typcdn.com/geekdada/8428849460_548622.png",alt:"carbon.png"}})]),t._v(" "),e("h3",{attrs:{id:"使用-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用")]),t._v(" "),e("p",[t._v("如果你已经配置好了一个 Artifact 名为 "),e("code",[t._v("surge.conf")]),t._v("，那该文件的访问地址就是：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("https://1234567890.cn-hongkong.fc.aliyuncs.com/2016-08-15/proxy/surgio-api/get-artifact/surge.conf\n")])])]),e("p",[t._v("为了让托管地址保持一致，你需要到 "),e("code",[t._v("surgio.conf.js")]),t._v(" 把 "),e("code",[t._v("urlBase")]),t._v(" 更新为：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("https://1234567890.cn-hongkong.fc.aliyuncs.com/2016-08-15/proxy/surgio-api/get-artifact/\n")])])]),e("p",[t._v("最后，再运行一次 "),e("code",[t._v("fun deploy")]),t._v(" 更新服务。")]),t._v(" "),e("h3",{attrs:{id:"最后-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#最后-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 最后")]),t._v(" "),e("p",[t._v("有几点需要大家注意的：")]),t._v(" "),e("ol",[e("li",[t._v("每一次更新本地的代码，都需要执行一次 "),e("code",[t._v("fun deploy")]),t._v("，保证远端和本地代码一致")]),t._v(" "),e("li",[t._v("访问日志、监控、域名绑定等复杂功能恕不提供教程")]),t._v(" "),e("li",[t._v("如果访问地址泄漏，请立即删除云函数然后修改机场密码")])]),t._v(" "),e("h2",{attrs:{id:"最后的最后"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#最后的最后","aria-hidden":"true"}},[t._v("#")]),t._v(" 最后的最后")]),t._v(" "),e("p",[t._v("API 能够极大地方便我们获取 Surgio 仓库中的规则。之后我还会为这个功能带来更多有趣的新特性。")])])}),[],!1,null,null,null);a.default=n.exports}}]);